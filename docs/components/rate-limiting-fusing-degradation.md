# 限流、熔断、降级设计

**限流**是在系统负载能力范围内发现有异常流量请求时主动做出的防御手段，比如碰到单一用户或来源短时间产生大量请求，超过设定阈值后停止处理此用户或来源的后续请求。

**熔断**是系统负载超负荷后被动触发及时停止接口响应的保护手段，熔断经常包含降级处理。

> 可以参考 Sentinel 的实现进行设计。

## 限流

设计目标：

+ 限流指标
+ 指标数据统计
+ 限流策略
+ 限流后请求处理
+ 限流恢复

### 限流指标

业内限流方案多采用 HPS （Hits Per Second，每秒点击数）或者 RPS（每秒请求数） 作为限流指标。

> HPS RPS 通常是一样的，QPS 侧重每秒完成的查询数量。

### 指标数据统计

很容易想到拦截请求进行统计，可以使用 Filter、Interceptor、AOP，Sentinel 使用了 Interceptor 和 AOP。

> Sentinel 使用 Interceptor 统计、校验**接口**限流指标数据，使用 AOP 实现统计、校验**用户自定义资源**限流指标数据。

指标数据结构：

对接口限流就是统计用户或来源对接口访问次数，统计 `UserId -> ReqeustMethod:APIRoute -> Count`。



### 限流策略

同样是在拦截请求时进行校验，



### 限流后请求处理

### 限流恢复



## 熔断



## 降级



## Sentinel 整合

主要是配置资源定义和规则管理。

**资源定义**：

可以引入组件自动注册资源（比如 `sentinel-spring-webmvc-adapter`），也可以通过 `@SentinelResource`  注解定义资源 以及定制 异常处理器和 Fallback 实现。

**规则管理**：

线上环境需要引入第三方配置中心，Dashboard 修改规则发送到配置中心，再由配置中心推送到各个 Sentinel 客户端。
但是注意 Dashboard 默认并不支持将规则发送到配置中心，需要用户自行修改。

如果不嫌麻烦、不嫌配置不好看也可以直接通过配置中心修改 Sentinel 规则。



